{% extends "base.htm" %}

{% block nav%}
{% endblock %}

{% block header %}
<h1>Where is everyone?</h1>
{% endblock %}


{% block head %}
<style>
	#map_canvas { height: 300px; width:100%; }

	.map_info_who { font-weight:bold}
	.map_info_place_name { text-decoration:italic}
	.map_info_addressP{ font-size:5px	}
</style>

<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
<script type="text/javascript" src="http://code.google.com/apis/gears/gears_init.js"></script>
<script type="text/javascript" src="/JS/search_map.js"></script>

<script type="text/javascript">

var count = 1;

function findItems( completed_func ){
	$("#map_success").slideUp( 'fast' );
	$("#map_error").slideUp( 'fast', function(){
		$("#map_working").html( "Working..." ).slideDown( 'slow' );
	});

	var bounds = map.getBounds();
	// Make the AJAX call to get the items within bounds
	$.ajax( {
				url: "/get_items?bounds=" + bounds.toUrlValue() + '&json=1', 
				dataType: 'json',
				error: function(jqXHR, textStatus, errorThrown){
					$("#map_working").slideUp( 'fast', function(){
							$("#map_error").html( "There was an error: " + jqXHR + ", " + textStatus + ", "+ errorThrown ).slideDown( 'slow' );
						} );
					},
				success: function( items_json ){
					//$("#received").html( "he: " + items_json );
					cleanMarkerList();
					var locations = eval( items_json );
					
					
					for( var loc in locations ){
						
						var coordinates = loc.split( "|");
						var items = locations[loc];
						createEventMarker( coordinates[0], coordinates[1], 
								"<div class='map_info_who'>" + items.length + " people hanging out at </div>" +
								"<div class='map_info_place_name'>" + items[0].where_name +  "</div>" + 
								"<div class='map_info_address'>" + items[0].where_addr + "</div>");
					} 
					completed_func();
					
				} 
			});
	
}

$(function () {
	$("#nav_browse").addClass( "active" );
	init_map_stuff( function(){
		findMeFnc( function(){
			findItems( function(){
				$("#map_working").slideUp( 'fast', function(){
					$("#map_success").html('Search Completed.').slideDown( 'slow' );
					} );
				})
			});
		
		} );
});

</script>
{% endblock %}

{% block main %}
<div id="received" ></div>
<div id="map_canvas" ></div>
<div id="map_success" class="alert-message success hidden"></div>
<div id="map_working"  class="alert-message info hidden "></div>
<div id="map_error"  class="alert-message error hidden"></div>

    {% for event in events %}
		{% include "event_snip.htm" %}
    {% endfor %}
    Display map
    <a href='/home'>Back</a>
{% endblock %}